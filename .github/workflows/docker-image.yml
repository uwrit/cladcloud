name: Build Docker Images

on:
  push:
    branches:
    - "main"
  pull_request:
    branches:
    - "main"

env:
  BUILD_NUM: $(date +%Y%m%d%H%M%S)

jobs:

  clear-cache:
    runs-on: self-hosted

    steps:
    - name: Clear docker cache
      run: docker system prune -af --volumes
    - name: export BUILD_NUM
      run: date +%Y%m%d%H%M%S > ~/BUILD_NUM

  build-degauss-api:
    runs-on: self-hosted
    needs: clear-cache

    steps:
    - uses: actions/checkout@v4
    - name: import BUILD_NUM
      run: echo "BUILD_NUM=$(cat ~/BUILD_NUM)" >> $GITHUB_ENV
    - name: print env
      run: env
    - name: Build the degauss-geocoder-api image
      run: docker build --load degauss-alpine/degauss-geocoder-api --tag degauss-geocoder-api:${{ env.BUILD_NUM }}
    - name: Run Trivy CVE vulnerability scanner
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: degauss-geocoder-api:${{ env.BUILD_NUM }}
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

  build-degauss-foundry:
    runs-on: self-hosted
    needs: clear-cache

    steps:
    - uses: actions/checkout@v4
    - name: print env
      run: env
    - name: Build the degauss-foundry image
      run: docker build degauss-foundry --tag degauss-foundry:$BUILD_NUM
    - name: Run Trivy CVE vulnerability scanner
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'degauss-foundry:$BUILD_NUM'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

  build-nominatim:
    runs-on: self-hosted
    needs: clear-cache

    steps:
    - uses: actions/checkout@v4
    - name: print env
      run: env
    - name: Build the nominatim image
      run: docker build nominatim-docker/nominatim-php83 --tag nominatim:$BUILD_NUM
    - name: Run Trivy CVE vulnerability scanner
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'nominatim:$BUILD_NUM'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

  build-postgis:
    runs-on: self-hosted
    needs: clear-cache

    steps:
    - uses: actions/checkout@v4
    - name: print env
      run: env
    - name: Build the postgis image
      run: docker build postgis-docker-alpine-db/src/alpinedb --tag postgis:$BUILD_NUM
    - name: Run Trivy CVE vulnerability scanner
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: 'postgis:$BUILD_NUM'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

name: Build Docker Images

on:
  push:
    branches:
    - "main"
  pull_request:
    branches:
    - "main"

jobs:

  build-degauss-api:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4
    - name: Build the degauss-geocoder-api image
      run: docker build degauss-alpine/degauss-geocoder-api --tag degauss-geocoder-api:$(date +%Y%m%d%H%M%S)
    - name: Run CVE check
      run: trivy image degauss-geocoder-api:latest

  build-degauss-foundry:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4
    - name: Build the degauss-foundry image
      run: docker build degauss-foundry --tag degauss-foundry:$(date +%Y%m%d%H%M%S)
    - name: Run CVE check
      run: trivy image degauss-foundry:latest

  build-nominatim:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4
    - name: Build the nominatim image
      run: docker build nominatim-docker/nominatim-php83 --tag nominatim:$(date +%Y%m%d%H%M%S)
    - name: Run CVE check
      run: trivy image nominatim:latest

  build-postgis:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4
    - name: Build the postgis image
      run: docker build postgis-docker-alpine-db/src/alpinedb --tag postgis:$(date +%Y%m%d%H%M%S)
    - name: Run CVE check
      run: trivy image postgis:latest
